services:
  # ── Core Database ──
  mongodb:
    image: mongo:7
    container_name: hydrobos-mongo
    ports:
      - "27017:27017"
    volumes:
      - hydrobos_mongo_data:/data/db
      - ./infrastructure/mongo-init:/docker-entrypoint-initdb.d:ro
    environment:
      MONGO_INITDB_DATABASE: hydrobos
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - hydrobos
    restart: unless-stopped

  # ── Cache & Sessions ──
  redis:
    image: redis:7-alpine
    container_name: hydrobos-redis
    ports:
      - "6379:6379"
    volumes:
      - hydrobos_redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hydrobos
    restart: unless-stopped

  # ── Event Bus ──
  kafka:
    image: apache/kafka:3.9.0
    container_name: hydrobos-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      CLUSTER_ID: "hydrobos-kafka-cluster-001"
    volumes:
      - hydrobos_kafka_data:/tmp/kraft-combined-logs
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - hydrobos
    restart: unless-stopped

  # ── Kafka UI (dev only) ──
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: hydrobos-kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: hydrobos
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - hydrobos
    profiles:
      - dev-tools
    restart: unless-stopped

  # ── Mongo Express (dev only) ──
  mongo-express:
    image: mongo-express:1
    container_name: hydrobos-mongo-ui
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017
      ME_CONFIG_BASICAUTH: "false"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - hydrobos
    profiles:
      - dev-tools
    restart: unless-stopped

  # ══════════════════════════════════════
  #  Application Services
  # ══════════════════════════════════════

  # ── Identity Service ──
  identity:
    build:
      context: .
      dockerfile: services/identity/Dockerfile
    image: hydrobos/identity:latest
    container_name: hydrobos-identity
    ports:
      - "5001:5001"
    environment:
      PORT: "5001"
      NODE_ENV: production
      MONGO_URI: mongodb://mongodb:27017/hydrobos
      MONGO_HOST: mongodb
      MONGO_PORT: "27017"
      JWT_SECRET: ${JWT_SECRET:-hydrobos-dev-secret}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      ENTRA_ENABLED: ${ENTRA_ENABLED:-false}
      ENTRA_TENANT_ID: ${ENTRA_TENANT_ID:-}
      ENTRA_CLIENT_ID: ${ENTRA_CLIENT_ID:-}
      ENTRA_CLIENT_SECRET: ${ENTRA_CLIENT_SECRET:-}
      ENTRA_REDIRECT_URI: ${ENTRA_REDIRECT_URI:-http://localhost:5000/api/auth/callback}
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5001/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - hydrobos
    restart: unless-stopped

  # ── Widget Service ──
  widget:
    build:
      context: .
      dockerfile: services/widget/Dockerfile
    image: hydrobos/widget:latest
    container_name: hydrobos-widget
    ports:
      - "5002:5002"
    environment:
      PORT: "5002"
      NODE_ENV: production
      MONGO_URI: mongodb://mongodb:27017/hydrobos
      JWT_SECRET: ${JWT_SECRET:-hydrobos-dev-secret}
      IDENTITY_SERVICE_URL: http://identity:5001
    depends_on:
      mongodb:
        condition: service_healthy
      identity:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5002/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - hydrobos
    restart: unless-stopped

  # ── API Gateway ──
  gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    image: hydrobos/gateway:latest
    container_name: hydrobos-gateway
    ports:
      - "5000:5000"
    environment:
      PORT: "5000"
      NODE_ENV: production
      CLIENT_URL: ${CLIENT_URL:-http://localhost:3000}
      IDENTITY_SERVICE_URL: http://identity:5001
      WIDGET_SERVICE_URL: http://widget:5002
    depends_on:
      identity:
        condition: service_healthy
      widget:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - hydrobos
    restart: unless-stopped

  # ── Client (Vite + React → Nginx) ──
  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    image: hydrobos/client:latest
    container_name: hydrobos-client
    ports:
      - "3000:80"
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - hydrobos
    restart: unless-stopped

volumes:
  hydrobos_mongo_data:
    driver: local
  hydrobos_redis_data:
    driver: local
  hydrobos_kafka_data:
    driver: local

networks:
  hydrobos:
    driver: bridge
    name: hydrobos-network
